!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.XbossDebug=t()}(this,function(){var e,t={typeDecide:function(e,t){return Object.prototype.toString.call(e)==="[object "+t+"]"},isFunction:function(e){return t.typeDecide(e,"Function")},isString:function(e){return t.typeDecide(e,"String")},serializeObj:function(e){var n="";return Object.keys(e).forEach(function(r){t.typeDecide(e[r],"Object")?n+=r+"="+t.stringify(e[r]):n+=r+"="+e[r]+"^"}),encodeURIComponent(n.substr(0,n.length-1))},assignObject:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},noop:function(){},now:function(){return(new Date).getTime()}},n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},u=function(){function e(r){n(this,e),this.config={version:"1.0.0",setSystemInfo:!1,setLocation:!1,key:"",mergeReport:!0,delay:1e3,url:"",except:[/^Script error\.?/,/^Javascript error: Script error\.? on line 0/],random:1,repeat:5},this.config=t.assignObject(this.config,r)}return r(e,[{key:"get",value:function(e){return this.config[e]}},{key:"set",value:function(e,t){return this.config[e]=t,this.config[e]}}]),e}();return new(function(e){function u(e){n(this,u);var t=i(this,(u.__proto__||Object.getPrototypeOf(u)).call(this,e));return t.breadcrumbs=[],t.activePage={},t.rewriteApp(),t.rewritePage(),t}return o(u,e),r(u,[{key:"rewriteApp",value:function(){var e=App,n=this;App=function(r){return["onLaunch","onShow","onHide","onError"].forEach(function(e){var o=r[e];"onLaunch"==e&&(n.getNetworkType(),n.config.setLocation&&n.getLocation(),n.config.setSystemInfo&&n.getSystemInfo()),r[e]=function(r){var i={type:"function",time:t.now(),belong:"App",method:e,path:r&&r.path,query:r&&r.query,scene:r&&r.scene};return n.pushToBreadcrumb(i),"onError"===e&&n.error({msg:r}),o&&o.call(this,r)}}),e(r)}}},{key:"rewritePage",value:function(){var e=this,t=Page;Page=function(n){return Object.keys(n).forEach(function(t){"function"==typeof n[t]&&e.recordPageFn(n,t)}),n.onReady||e.recordPageFn(n,"onReady"),n.onLoad||e.recordPageFn(n,"onLoad"),t(n)}}},{key:"getActivePage",value:function(){var e=getCurrentPages();if(e.length)return e[e.length-1]}},{key:"pushToBreadcrumb",value:function(e){this.breadcrumbs.push(e),this.breadcrumbs.length>20&&this.breadcrumbs.shift()}},{key:"recordPageFn",value:function(e,n){var r=e[n],o=this;e[n]=function(){"onLoad"!==n&&"onShow"!==n||(o.activePage=o.getActivePage());var e={type:"function",time:t.now(),belong:"Page",method:n,route:o.activePage&&o.activePage.route,options:o.activePage&&o.activePage.options};return"onLoad"===n&&(e.args=arguments),o.methodFilter(n)&&o.pushToBreadcrumb(e),r&&r.apply(this,arguments)}}},{key:"methodFilter",value:function(e){return"onPageScroll"!==e}},{key:"getNetworkType",value:function(){var e=this;wx.getNetworkType({success:function(t){e.networkType=t.networkType}})}},{key:"getSystemInfo",value:function(){var e=this;wx.getSystemInfo({success:function(t){e.systemInfo=t}})}},{key:"getLocation",value:function(){var e=this;wx.getLocation({type:"wgs84",success:function(t){e.locationInfo=t}})}}]),u}(function(e){return function(t){function u(e){n(this,u);var t=i(this,(u.__proto__||Object.getPrototypeOf(u)).call(this,e));return t.handlers={},t}return o(u,e),r(u,[{key:"on",value:function(e,t){return this.handlers[e]=this.handlers[e]||[],this.handlers[e].push(t),this.handlers[e]}},{key:"off",value:function(e){this.handlers[e]&&delete this.handlers[e]}},{key:"trigger",value:function(e,t){var n=this,r=t||[],o=this.handlers[e];return!o||o.every(function(e){return!1!==e.apply(n,r)})}}]),u}()}((e=u,function(u){function c(e){n(this,c);var t=i(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,e));return t.errorQueue=[],t.repeatList={},t.url=t.config.url,["log","debug","info","warn","error"].forEach(function(e,n){t[e]=function(r){return t.handleMsg(r,e,n)}}),t}return o(c,e),r(c,[{key:"repeat",value:function(e){var t=e.rowNum||"",n=e.colNum||"",r=e.msg+t+n;return this.repeatList[r]=this.repeatList[r]?this.repeatList[r]+1:1,this.repeatList[r]>this.config.repeat}},{key:"except",value:function(e){var n=this.config.except,r=!1,o=null;if(t.typeDecide(n,"Array"))for(var i=0,u=n.length;i<u;i++)if(o=n[i],t.typeDecide(o,"RegExp")&&o.test(e.msg)||t.typeDecide(o,"Function")&&o(e,e.msg)){r=!0;break}return r}},{key:"request",value:function(e,t,n){this.config.key?(t.key=this.config.key,wx.request({url:e,method:"POST",data:t,success:n})):console.warn("please set key in xbossdebug.config.key")}},{key:"report",value:function(e){var t=this,n=this.config.mergeReport;if(0===this.errorQueue.length)return this.config.url;var r=n?this.errorQueue:[this.errorQueue.shift()];n&&(this.errorQueue=[]);var o=this.config.url,i={error:r,systemInfo:this.systemInfo,breadcrumbs:this.breadcrumbs,locationInfo:this.locationInfo,networkType:this.networkType,notifierVersion:this.config.version};return this.request(o,i,function(){e&&e.call(t),t.trigger("afterReport")}),o}},{key:"send",value:function(e){var n=this;if(this.trigger("beforeReport")){var r=e||t.noop,o=this.config.mergeReport?this.config.delay:0;setTimeout(function(){n.report(r)},o)}}},{key:"catchError",value:function(e){return!(Math.random()>=this.config.random)&&!this.repeat(e)&&!this.except(e)&&(this.errorQueue.push(e),this.errorQueue)}},{key:"handleMsg",value:function(e,n,r){if(!e)return!1;var o=t.typeDecide(e,"Object")?e:{msg:e};return o.level=r,o.type=n,this.catchError(o)&&this.send(),o}}]),c}()))))});
